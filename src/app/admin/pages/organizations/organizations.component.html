<clark-admin-content-wrapper>
  <div page-title>
    <div class="title-stack">
      <div>Organizations</div>
      <span class="title-subtext"
        >Review and manage organization verification status</span
      >
    </div>
  </div>

  <div class="overview-row" search>
    <div class="overview-card">
      <div class="overview-card__label">Total</div>
      <div class="overview-card__value">{{ dataSource.data.length }}</div>
    </div>
    <div class="overview-card">
      <div class="overview-card__label">Verified</div>
      <div class="overview-card__value">
        {{ dataSource.filteredData.filter(o => o.isVerified).length }}
      </div>
    </div>
    <div class="overview-card">
      <div class="overview-card__label">Unverified</div>
      <div class="overview-card__value">
        {{ dataSource.filteredData.filter(o => !o.isVerified).length }}
      </div>
    </div>
    <div class="overview-card">
      <div class="overview-card__label">Users in "Other"</div>
      <div class="overview-card__value">{{ getTotalOtherUsers() }}</div>
    </div>
  </div>

  <div class="filters-toolbar" search>
    <div class="inline-filters">
      <label class="search-control" aria-label="Search organizations">
        <mat-icon class="search-icon">search</mat-icon>
        <input
          type="text"
          placeholder="Search organizations"
          (keyup)="applyFilter($event)"
        />
      </label>

      <button
        *ngIf="!isPhoneTableView"
        class="filter-dropdown-btn"
        [ngClass]="{ active: selectedVerifiedFilters.length > 0 }"
        [matMenuTriggerFor]="verifiedMenu"
      >
        {{
          selectedVerifiedFilters.length === 0
            ? 'Verified'
            : 'Verified (' + selectedVerifiedFilters.length + ')'
        }}
        <i class="far fa-chevron-down"></i>
      </button>

      <button
        *ngIf="!isPhoneTableView"
        class="filter-dropdown-btn"
        [ngClass]="{ active: selectedSectorFilters.length > 0 }"
        [matMenuTriggerFor]="sectorMenu"
      >
        {{
          selectedSectorFilters.length === 0
            ? 'Sector'
            : 'Sector (' + selectedSectorFilters.length + ')'
        }}
        <i class="far fa-chevron-down"></i>
      </button>

      <button
        *ngIf="!isPhoneTableView"
        class="filter-dropdown-btn"
        [ngClass]="{ active: selectedLevelFilters.length > 0 }"
        [matMenuTriggerFor]="levelMenu"
      >
        {{
          selectedLevelFilters.length === 0
            ? 'Level'
            : 'Level (' + selectedLevelFilters.length + ')'
        }}
        <i class="far fa-chevron-down"></i>
      </button>

      <button
        *ngIf="!isPhoneTableView && hasActiveFilters()"
        class="clear-filters-link"
        (click)="clearAllFilters()"
      >
        Clear Filters
      </button>
    </div>

    <div class="toolbar-pager">
      <mat-paginator
        *ngIf="!isMobileTableView"
        class="organizations-paginator"
        [pageSizeOptions]="[10, 25, 50, 100]"
        showFirstLastButtons
        aria-label="Select page of organizations"
      >
      </mat-paginator>
    </div>

    <div class="toolbar-actions" *ngIf="!isPhoneTableView">
      <button
        mat-raised-button
        color="primary"
        (click)="openCreateModal()"
        class="create-org-button"
      >
        <mat-icon>add</mat-icon>
        New Organization
      </button>
    </div>
  </div>

  <div #list class="list" main>
    <div *ngIf="dataSource.data?.length; else emptyTemplate">
      <div class="table-shell">
        <table
          mat-table
          [dataSource]="dataSource"
          matSort
          class="organizations-table"
        >
          <ng-container matColumnDef="verified">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Verified</th>
            <td mat-cell *matCellDef="let organization">
              <mat-icon
                class="verified-status-icon"
                [ngClass]="organization.isVerified ? 'verified' : 'unverified'"
                [attr.aria-label]="
                  organization.isVerified ? 'Verified' : 'Unverified'
                "
              >
                {{ organization.isVerified ? 'check_circle' : 'cancel' }}
              </mat-icon>
            </td>
          </ng-container>

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
            <td mat-cell *matCellDef="let organization">
              <div class="org-name-cell">{{ organization.name }}</div>
              <div class="org-domain" *ngIf="organization.domains?.length > 0">
                {{ organization.domains[0] }}
                <span *ngIf="organization.domains.length > 1">
                  +{{ organization.domains.length - 1 }}
                </span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="users">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Users</th>
            <td mat-cell *matCellDef="let organization">
              <span class="count-value">{{ getUserCount(organization) }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="learningObjects">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Learning Objects
            </th>
            <td mat-cell *matCellDef="let organization">
              <span class="count-value">{{
                getLearningObjectCount(organization)
              }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="sector">
            <th mat-header-cell *matHeaderCellDef>Sector</th>
            <td mat-cell *matCellDef="let organization">
              <span
                class="sector-badge"
                [ngClass]="'sector-' + organization.sector"
              >
                {{ organization.sector | titlecase }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="levels">
            <th mat-header-cell *matHeaderCellDef>Levels</th>
            <td mat-cell *matCellDef="let organization">
              <div class="levels-list">
                <span
                  class="level-pill"
                  *ngFor="let level of organization.levels.slice(0, 3)"
                >
                  {{ formatLevelName(level) | titlecase }}
                </span>
                <span
                  *ngIf="organization.levels.length > 3"
                  class="level-pill level-pill--more"
                >
                  +{{ organization.levels.length - 3 }}
                </span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td
              mat-cell
              *matCellDef="let organization"
              (click)="$event.stopPropagation()"
            >
              <div class="action-icons">
                <ng-container *ngIf="!isMobileTableView; else mobileActions">
                  <button
                    mat-icon-button
                    (click)="openEditModal(organization)"
                    class="action-icon-button"
                    title="Edit"
                  >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="openMigrateModal(organization)"
                    class="action-icon-button migrate"
                    title="Migrate Users"
                    [disabled]="getUserCount(organization) === 0"
                  >
                    <mat-icon>sync_alt</mat-icon>
                  </button>
                  <span
                    [matTooltip]="
                      getUserCount(organization) > 0
                        ? 'Organizations must have 0 users before they can be deleted.'
                        : ''
                    "
                    [matTooltipDisabled]="getUserCount(organization) === 0"
                  >
                    <button
                      mat-icon-button
                      (click)="openDeleteModal(organization)"
                      class="action-icon-button delete"
                      title="Delete"
                      [disabled]="getUserCount(organization) > 0"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </span>
                </ng-container>
                <ng-template #mobileActions>
                  <button
                    mat-icon-button
                    class="action-icon-button action-meatball"
                    [matMenuTriggerFor]="rowActionMenu"
                    [matMenuTriggerData]="{ organization: organization }"
                    title="Actions"
                  >
                    <mat-icon>more_vert</mat-icon>
                  </button>
                </ng-template>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            class="organization-row"
            (click)="openEditModal(row)"
          ></tr>
        </table>
      </div>
      <div
        class="table-toolbar table-toolbar--bottom"
        *ngIf="isMobileTableView"
      >
        <mat-paginator
          class="organizations-paginator"
          [pageSizeOptions]="[10, 25, 50, 100]"
          showFirstLastButtons
          aria-label="Select page of organizations"
        >
        </mat-paginator>
      </div>
    </div>
  </div>

  <mat-menu #rowActionMenu="matMenu" class="filter-menu row-action-menu">
    <ng-template matMenuContent let-organization="organization">
      <button mat-menu-item (click)="openEditModal(organization)">
        <mat-icon>edit</mat-icon>
        <span>Edit</span>
      </button>
      <button
        mat-menu-item
        (click)="openMigrateModal(organization)"
        [disabled]="getUserCount(organization) === 0"
      >
        <mat-icon>sync_alt</mat-icon>
        <span>Migrate Users</span>
      </button>
      <button
        mat-menu-item
        (click)="openDeleteModal(organization)"
        [disabled]="getUserCount(organization) > 0"
      >
        <mat-icon>delete</mat-icon>
        <span>Delete</span>
      </button>
    </ng-template>
  </mat-menu>

  <mat-menu #verifiedMenu="matMenu" class="filter-menu">
    <div class="filter-menu-content" (click)="$event.stopPropagation()">
      <mat-checkbox
        class="filter-menu-checkbox"
        [checked]="selectedVerifiedFilters.includes('verified')"
        (change)="toggleVerifiedFilter('verified')"
      >
        Verified
      </mat-checkbox>
      <mat-checkbox
        class="filter-menu-checkbox"
        [checked]="selectedVerifiedFilters.includes('unverified')"
        (change)="toggleVerifiedFilter('unverified')"
      >
        Unverified
      </mat-checkbox>
    </div>
  </mat-menu>

  <mat-menu #sectorMenu="matMenu" class="filter-menu">
    <div class="filter-menu-content" (click)="$event.stopPropagation()">
      <mat-checkbox
        class="filter-menu-checkbox"
        *ngFor="let sector of sectorOptions"
        [checked]="selectedSectorFilters.includes(sector)"
        (change)="toggleSectorFilter(sector)"
      >
        {{ sector | titlecase }}
      </mat-checkbox>
    </div>
  </mat-menu>

  <mat-menu #levelMenu="matMenu" class="filter-menu">
    <div class="filter-menu-content" (click)="$event.stopPropagation()">
      <mat-checkbox
        class="filter-menu-checkbox"
        *ngFor="let level of levelOptions"
        [checked]="selectedLevelFilters.includes(level)"
        (change)="toggleLevelFilter(level)"
      >
        {{ formatLevelName(level) | titlecase }}
      </mat-checkbox>
    </div>
  </mat-menu>

  <ng-template #emptyTemplate>
    <div class="empty-template" *ngIf="!loading; else loadingTemplate">
      <div class="empty-template__top">
        <i class="fal fa-building"></i>
        <div class="top-message">Nothing here!</div>
      </div>
      <div class="empty-text">Organizations will appear here</div>
    </div>
  </ng-template>

  <ng-template #loadingTemplate>
    <div class="loadingOrFinished__content">
      <i class="fal fa-spinner-third fa-spin"></i>
      Loading...
    </div>
  </ng-template>
</clark-admin-content-wrapper>

<!-- Organization Edit Modal -->
<clark-organization-edit-modal
  [isVisible]="displayEditModal"
  [isCreateMode]="isCreateMode"
  [organization]="selectedOrganization"
  [userCount]="selectedOrganization ? getUserCount(selectedOrganization) : 0"
  [existingNames]="getExistingNames()"
  (closed)="closeEditModal()"
  (save)="onSaveOrganization($event)"
></clark-organization-edit-modal>

<!-- Delete Confirmation Modal -->
<clark-organization-delete-modal
  [isVisible]="displayDeleteModal"
  [organization]="selectedOrganization"
  (closed)="closeDeleteModal()"
  (confirm)="deleteOrganization()"
></clark-organization-delete-modal>

<!-- Migrate Users Modal -->
<clark-organization-migrate-modal
  [isVisible]="displayMigrateModal"
  [sourceOrganization]="selectedOrganization"
  [sourceUserCount]="
    selectedOrganization ? getUserCount(selectedOrganization) : 0
  "
  [availableTargetOrganizations]="getAvailableTargetOrganizations()"
  [isMigrating]="isMigrating"
  [getUserCount]="getUserCount.bind(this)"
  (closed)="closeMigrateModal()"
  (migrate)="onMigrateUsers($event)"
></clark-organization-migrate-modal>
