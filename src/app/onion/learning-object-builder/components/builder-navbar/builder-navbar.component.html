<div class="modern-builder-navbar">
    <clark-skip-link title="Skip Builder Form" skipLocation="form"></clark-skip-link>
    <clark-skip-link title="Skip to Children" skipLocation="children"></clark-skip-link>
    <clark-skip-link title="Skip to Submit for Review" skipLocation="submit"></clark-skip-link>

  <div class="navbar-header" [class.has-revision]="revisedVersion">
    <div
      *ngIf="revisedVersion && !adminMode"
      aria-live="assertive"
      class="revision-banner"
    >
      <div class="revision-content">
        <i class="fas fa-edit"></i>
        <span>Currently Revising: <strong>{{ learningObject?.name }}</strong></span>
      </div>
    </div>
    <div class="navbar-actions-left">
      <button class="action-button back-button" *ngIf="!adminMode" (click)="triggerExitProcess()">
        <i class="far fa-arrow-left"></i>
        <span>Back to Dashboard</span>
      </button>
      <button class="action-button bundle-button" *ngIf="adminMode" (click)="triggerExitProcess(false)">
        <i class="far fa-file-archive"></i>
        <span>Bundle</span>
      </button>
    </div>
    <div class="navbar-actions-right">
      <div
        *ngIf="
          !['unreleased', 'rejected'].includes(learningObject?.status) &&
          learningObject?.collection
        "
        class="collection-badge"
        tip="This learning object has been submitted to the {{
          collection?.name
        }} collection."
        tipPosition="bottom"
      >
        <div class="collection-info">
          <span class="collection-label">Collection:</span>
          <span class="collection-name">{{ collection.name }}</span>
        </div>
        <div class="collection-logo">
          <div
            *ngIf="collection.hasLogo; else genericCollectionLogoTemplate"
            class="logo-image"
            [style.background-image]="
              'url(assets/images/collections/' +
              learningObject?.collection +
              '.png)'
            "
          ></div>
        </div>
      </div>
      <div class="status-container">
        <clark-lo-status-indicator
          [status]="learningObject?.status"
          [states]="states"
        ></clark-lo-status-indicator>
      </div>
      <ng-container *ngIf="!adminMode; else adminModeTemplate">
        <button
          id="submit"
          class="submit-button"
          *ngIf="['unreleased'].includes(learningObject?.status)"
          [class.success]="!submissionError"
          [class.error]="validator.submissionMode && submissionError"
          [class.disabled]="!auth.user.emailVerified"
          (click)="auth.user.emailVerified && triggerSubmit()"
        >
          <div class="button-content">
            <div
              *ngIf="validator.submissionMode && submissionError"
              class="cancel-overlay"
              tip="Cancel Submission"
              tipPosition="bottom"
              (click)="$event.stopPropagation(); validator.submissionMode = false"
            >
              <i class="far fa-times"></i>
            </div>
            <span class="button-text">
              {{
                validator.submissionMode && submissionError
                  ? 'Try Again'
                  : 'Submit for review'
              }}
            </span>
            <i class="far fa-arrow-right button-icon"></i>
          </div>
        </button>
      </ng-container>
      <ng-template #adminModeTemplate>
        <clark-editor-action-panel
          [learningObject]="learningObject"
        ></clark-editor-action-panel>
      </ng-template>
    </div>
  </div>

  <div class="navbar-bottom">
    <div class="navigation-tabs">
      <div class="tab-list">
        <ng-container
          id="firstTab"
          aria-label="Basic Information Link"
          [ngTemplateOutlet]="modernNavItemTemplate"
          [ngTemplateOutletContext]="{
            disabled: false,
            link: 'info',
            text: 'Basic Information',
            icon: 'far fa-info-circle',
            description: 'Name, description, and basic details'
          }"
        ></ng-container>

        <ng-container
          aria-label="Learning Outcomes Link"
          [ngTemplateOutlet]="modernNavItemTemplate"
          [ngTemplateOutletContext]="{
            disabled: !canRoute('outcomes'),
            link: 'outcomes',
            text: 'Learning Outcomes',
            icon: 'far fa-bullseye',
            description: 'Define learning objectives'
          }"
        ></ng-container>

        <ng-container
          aria-label="Materials Link"
          [ngTemplateOutlet]="modernNavItemTemplate"
          [ngTemplateOutletContext]="{
            disabled: !canRoute('materials'),
            link: 'materials',
            text: 'Materials',
            icon: 'far fa-folder-open',
            description: 'Upload files and resources'
          }"
        ></ng-container>
      </div>

      <div class="saving-indicator">
        <div class="indicator-content" [class.saving]="isSaving">
          <div class="indicator-icon">
            <i [class]="isSaving ? 'fas fa-sync fa-spin' : 'fas fa-check'"></i>
          </div>
          <span class="indicator-text">
            {{ isSaving ? 'Saving changes...' : 'All changes saved' }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<clark-submit
  *ngIf="showSubmission"
  [learningObject]="store.learningObject"
  [learningOutcomes]="store.outcomes"
  [visible]="true"
  (close)="showSubmission = false"
></clark-submit>

<ng-template
  #modernNavItemTemplate
  let-link="link"
  let-disabled="disabled"
  let-text="text"
  let-icon="icon"
  let-description="description"
>
  <button
    *ngIf="!disabled"
    class="nav-tab"
    [class.new]="isNewRoute(link)"
    [class.active]="router.url.includes(link)"
    [routerLink]="link"
    routerLinkActive="active"
    (click)="triggerRouteClick(link)"
  >
    <div class="tab-content">
      <div class="tab-icon">
        <i [class]="icon"></i>
      </div>
      <div class="tab-text">
        <span class="tab-title">{{ text }}</span>
        <span class="tab-description">{{ description }}</span>
      </div>
    </div>
  </button>

  <button
    *ngIf="disabled"
    class="nav-tab disabled"
    aria-label="Please give this learning object a name before adding outcomes or uploading materials"
    tip="Please give this learning object a name before adding outcomes or uploading materials"
    tipPosition="top"
    disabled
  >
    <div class="tab-content">
      <div class="tab-icon">
        <i class="fas fa-lock"></i>
      </div>
      <div class="tab-text">
        <span class="tab-title">{{ text }}</span>
        <span class="tab-description">{{ description }}</span>
      </div>
    </div>
  </button>
</ng-template>

<!-- Legacy template for backward compatibility -->
<ng-template
  #navItemTemplate
  let-link="link"
  let-disabled="disabled"
  let-text="text"
>
  <a
    *ngIf="!disabled"
    [ngClass]="{ new: isNewRoute(link) }"
    routerLink="{{ link }}"
    routerLinkActive="active"
    (activate)="triggerRouteClick(link)"
    >{{ text }}</a
  >
  <a
    aria-label="Please give this learning object a name before adding outcomes or uploading materials"
    *ngIf="disabled"
    class="disabled"
    tip="Please give this learning object a name before adding outcomes or uploading materials"
    tipPosition="top"
    ><i class="fas fa-lock"></i>{{ text }}</a
  >
</ng-template>

<ng-template #genericCollectionLogoTemplate>
  <clark-generic-collection-logo size="small"></clark-generic-collection-logo>
</ng-template>
