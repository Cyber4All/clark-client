version: 2.1

orbs:
  cyber4all: cyber4all/orb@2.1.1

workflows:
  integration-testing:
    jobs:
      - cyber4all/build:
          language: node
  
  deploy-clark-service-refactor:
    when:
        equal: [clark-service-refactor, <<pipeline.git.branch>>]
    jobs:
      - cyber4all/s3:
          context: [AWS, Slack]
          bucket: "clark-staging-file-uploads"
          role-arn: S3_STAGING_OIDC_ROLE

  continuous-deployment:
    when:
        equal: [releases, <<pipeline.git.branch>>]
    jobs:
      - cyber4all/s3:
          context: [AWS, Slack]
          bucket: "clark-prod-file-uploads"
      
      - cyber4all/release:
          context: [Github]
          tag: $(jq -r '.version' package.json)
