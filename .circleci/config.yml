version: 2.1

orbs:
  cyber4all: cyber4all/orb@2.2.0
  slack: circleci/slack@6.1.3

jobs:
  lint:
    docker:
      - image: cimg/node:22.13.1
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-cache-v1-{{ checksum "package-lock.json" }}
            - npm-cache-v1-
      - run: npm ci
      - save_cache:
          key: npm-cache-v1-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
      - run: npm run lint

  build:
    parameters:
      environment:
        type: enum
        enum: [staging, prod]
    docker:
      - image: cimg/node:22.13.1
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-cache-v1-{{ checksum "package-lock.json" }}
            - npm-cache-v1-
      - run: npm ci
      - save_cache:
          key: npm-cache-v1-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
      - run:
          name: Ensure rollup optional binary is present
          command: node -e "require.resolve('@rollup/rollup-linux-x64-gnu')" || npm i --no-save @rollup/rollup-linux-x64-gnu@4.22.4
      - run:
          name: Build << parameters.environment >>
          command: npm run build:<< parameters.environment >>
      - persist_to_workspace:
          root: .
          paths:
            - dist/browser
            - src
            - angular.json
            - package.json
            - package-lock.json
            - tsconfig.json
            - .eslintrc.json

  upload-source-maps:
    parameters:
      environment:
        type: enum
        enum: [staging, prod]
    docker:
      - image: cimg/node:22.13.1
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Upload source maps to Coralogix
          command: |
            PACKAGE_VERSION=$(node -p "require('./package.json').version")
            if [ "<< parameters.environment >>" = "staging" ]; then
              COMMIT_HASH=${CIRCLE_SHA1:0:7}
              export RUM_VERSION="${PACKAGE_VERSION}-${COMMIT_HASH}"
            else
              export RUM_VERSION=${PACKAGE_VERSION}
            fi
            npm run rum:upload-<< parameters.environment >>

  semgrep-sast:
    docker:
      - image: semgrep/semgrep:1.153.0
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run Semgrep SAST scan
          command: |
            mkdir -p reports
            semgrep scan --config auto --json --output reports/semgrep-sast.json .
            semgrep scan --config auto --junit-xml --output reports/semgrep-sast.junit.xml .
      - store_artifacts:
          path: reports/semgrep-sast.json
      - store_test_results:
          path: reports/semgrep-sast.junit.xml

  trivy-sca-sbom:
    docker:
      - image: aquasec/trivy:0.69.1
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - trivy-db-v1
      - run:
          name: Run Trivy SCA scan
          command: |
            mkdir -p reports
            trivy fs --scanners vuln --format json --output reports/trivy-sca.json .
            trivy fs --scanners vuln --format template --template "@/contrib/junit.tpl" --output reports/trivy-sca.junit.xml .
      - run:
          name: Generate CycloneDX SBOM
          command: trivy fs --format cyclonedx --output reports/sbom.cdx.json .
      - save_cache:
          key: trivy-db-v1
          paths:
            - ~/.cache/trivy
      - store_artifacts:
          path: reports/trivy-sca.json
      - store_artifacts:
          path: reports/sbom.cdx.json
      - store_test_results:
          path: reports/trivy-sca.junit.xml

  deploy-s3:
    parameters:
      bucket:
        type: string
      distribution_id:
        type: env_var_name
      environment_name:
        type: string
      component_name:
        type: string
        default: clark-client
    docker:
      - image: cimg/aws:2025.01
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Plan deployment marker
          command: |
            TARGET_VERSION="$(node -p "require('./package.json').version")-${CIRCLE_SHA1:0:7}"
            DEPLOY_NAME="deploy-<< parameters.environment_name >>-<< parameters.component_name >>"
            echo "export DEPLOY_NAME=${DEPLOY_NAME}" >> "$BASH_ENV"
            circleci run release plan "$DEPLOY_NAME" \
              --environment-name="<< parameters.environment_name >>" \
              --component-name="<< parameters.component_name >>" \
              --target-version="${TARGET_VERSION}"
      - run:
          name: Sync build output to S3
          command: aws s3 sync ./dist/browser s3://<< parameters.bucket >> --delete
      - run:
          name: Invalidate CloudFront
          command: aws cloudfront create-invalidation --distribution-id "$<< parameters.distribution_id >>" --paths "/*"
      - run:
          name: Mark deployment success
          when: on_success
          command: circleci run release update "$DEPLOY_NAME" --status=SUCCESS
      - run:
          name: Mark deployment failure
          when: on_fail
          command: circleci run release update "$DEPLOY_NAME" --status=FAILED
      - slack/notify:
          event: fail
          template: basic_fail_1
      - slack/notify:
          event: pass
          template: success_tagged_deploy_1

workflows:
  continuous-integration:
    jobs:
      - lint:
          filters:
            branches:
              ignore: [main, releases]
      - build:
          name: build
          environment: prod
          filters:
            branches:
              ignore: [main, releases]
      - semgrep-sast:
          requires:
            - build
      - trivy-sca-sbom:
          requires:
            - build

  deploy-staging:
    when:
      equal: [main, << pipeline.git.branch >>]
    jobs:
      - lint
      - build:
          name: build-staging
          environment: staging
      - semgrep-sast:
          requires:
            - build-staging
      - trivy-sca-sbom:
          requires:
            - build-staging
      - upload-source-maps:
          name: upload-source-maps-staging
          environment: staging
          requires:
            - lint
            - build-staging
            - semgrep-sast
            - trivy-sca-sbom
      - deploy-s3:
          context:
            - aws_staging
            - Slack
          bucket: "clark-client-staging"
          distribution_id: STAGING_CLOUDFRONT_ID
          environment_name: clark-staging
          requires:
            - upload-source-maps-staging

  deploy-prod:
    when:
      equal: [releases, << pipeline.git.branch >>]
    jobs:
      - lint
      - build:
          name: build-production
          environment: prod
      - semgrep-sast:
          requires:
            - build-production
      - trivy-sca-sbom:
          requires:
            - build-production
      - cyber4all/release:
          context: [Github]
          tag: $(jq -r '.version' package.json)
          requires:
            - lint
            - build-production
            - semgrep-sast
            - trivy-sca-sbom
      - upload-source-maps:
          name: upload-source-maps-production
          environment: prod
          requires:
            - cyber4all/release
      - deploy-s3:
          name: deploy-s3-production
          context:
            - AWS
            - Slack
          bucket: "clark.center"
          distribution_id: CLOUDFRONT_ID
          environment_name: clark-production
          requires:
            - upload-source-maps-production
