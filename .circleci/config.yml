version: 2.1

orbs:
  cyber4all: cyber4all/orb@1

jobs:
  sbom:
    parameters:
      language:
        type: enum
        enum: ["node", "python", "go"]
        description: |
          Language of the repository generating an SBOM for.
          Options: (node, python, go)

      version:
        type: string
    machine:
      image: ubuntu-2004:current
    steps:
      - checkout
      - run:
          command: ./create-story.sh
          environment:
            LANGUAGE: << parameters.language >>
            VERSION: << parameters.version >>

workflows:
  integration-testing:
    jobs:
      - cyber4all/deploy-s3:
          deploy: false # explicitly shows in develeopment
          filters:
            branches:
              ignore: releases

      - cyber4all/test-app:
          docker-image: cimg/node:lts
          node-test: test:unit
          isNode: true

  continuous-deployment:
    jobs:
      - sbom:
          context: [Shortcut]
          language: node
          version: "$(jq -r '.version' package.json)"
          filters:
            branches:
                only:
                  - releases
                  - chore/sc-14941/add-sbom-on-releases

      - cyber4all/deploy-s3:
          context:
            [AWS, Slack]
          tag: $(cat ./package.json | grep version | head -1 | awk -F= "{ print $2 }" | sed 's/[version:,\",]//g' | tr -d '[[:space:]]')
          deploy: true
          source: dist
          isAngular: true
          filters:
            branches:
              only:
                - releases
